/* Copyright 2025 Google LLC */

import { ref, computed } from 'vue';
import { A2UISurface, A2UI } from '@a2ui/vue';

// State
const userInput = ref('');
const chatMessages = ref([]);
const a2uiMessages = ref([]);
const loading = ref(false);
const error = ref(null);

// Computed
const hasMessages = computed(() => chatMessages.value.length > 0);

// 处理用户输入
async function handleSubmit() {
  if (!userInput.value.trim() || loading.value) return;
  
  const message = userInput.value.trim();
  userInput.value = '';
  error.value = null;
  
  chatMessages.value.push({ role: 'user', content: message });
  loading.value = true;
  
  try {
    const response = await fetch('/a2a/invoke', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message }),
    });
    
    if (!response.ok) throw new Error(HTTP );
    
    const parts = await response.json();
    const newMessages = extractA2UIMessages(parts);
    
    if (newMessages.length > 0) {
      a2uiMessages.value = [...a2uiMessages.value, ...newMessages];
    }
    
    // Extract text
    const textParts = parts.filter(p => p.kind === 'text');
    if (textParts.length > 0) {
      const text = textParts.map(p => p.text).join('\n');
      chatMessages.value.push({ role: 'agent', content: text });
    }
  } catch (err) {
    error.value = err.message;
  } finally {
    loading.value = false;
  }
}

// 提取 A2UI 消息
function extractA2UIMessages(parts) {
  const messages = [];
  for (const part of parts) {
    if (part.kind === 'data' && part.data) {
      if (part.data.beginRendering) messages.push({ beginRendering: part.data.beginRendering });
      if (part.data.surfaceUpdate) messages.push({ surfaceUpdate: part.data.surfaceUpdate });
      if (part.data.dataModelUpdate) messages.push({ dataModelUpdate: part.data.dataModelUpdate });
    }
  }
  return messages;
}

// 处理用户操作
function handleAction(action, context) {
  console.log('Action:', action, context);
  chatMessages.value.push({ role: 'user', content: Action:  });
  // TODO: Send action to agent
}

function clearChat() {
  chatMessages.value = [];
  a2uiMessages.value = [];
  error.value = null;
}
